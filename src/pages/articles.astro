---
import Layout from "../layouts/Layout.astro";
import Icon from "../components/Icon.astro";
import products from "../data/products";

const base = import.meta.env.BASE_URL;

const resolveImage = (path: string) => (path?.startsWith("http") ? path : base + path);

const categoryIcons: Record<string, string> = {
  Aspirateurs: "device-vacuum"
};

const categories = Object.values(
  products.reduce((acc, product) => {
    const key = product.category;
    if (!acc[key]) {
      acc[key] = {
        name: product.category,
        slug: product.category.toLowerCase(),
        icon: categoryIcons[product.category] ?? "folder",
        count: 0
      };
    }
    acc[key].count += 1;
    return acc;
  }, {} as Record<string, { name: string; slug: string; icon: string; count: number }>)
);

const articles = products.map(product => ({
  title: `${product.name} - Test & Avis Complet`,
  slug: product.slug,
  category: product.category,
  excerpt: product.metaDescription,
  image: resolveImage(product.images.main),
  rating: product.rating,
  publishDate: product.dates.publish,
  readTime: product.dates.readTime
}));
---

<Layout
  title="Tous nos articles 2026"
  description="Parcourez tous nos tests produits, comparatifs et guides d'achat. Sélection mise à jour en 2026 pour choisir en toute confiance."
  canonicalUrl={base + "articles"}
>
  <article class="page-shell">

    <section class="featured-section">
      <div class="section-header">
        <div>
          <p class="section-kicker">Dernières publications</p>
          <h2 class="section-title">
            <Icon name="star" class="icon-accent" /> Articles récents
          </h2>
          <p class="section-subtitle">Découvrez nos derniers tests et avis produits.</p>
        </div>
      </div>

      <div class="articles-grid">
        {articles.map(article => (
          <article class="article-card">
            <a href={base + article.slug} class="article-link">
              <div class="article-image">
                <img src={article.image} alt={article.title} />
                <span class="article-category">{article.category}</span>
              </div>
              <div class="article-content">
                <div class="article-rating">
                  <Icon name="star" class="icon-accent" size={16} />
                  <span>{article.rating}/5</span>
                </div>
                <h3 class="article-title">{article.title}</h3>
                <p class="article-excerpt">{article.excerpt}</p>
                <div class="article-meta">
                  <time datetime={article.publishDate}>{article.publishDate}</time>
                  <span class="separator">•</span>
                  <span>{article.readTime} de lecture</span>
                </div>
                <div class="article-cta">
                  <span class="read-more">Lire l'article complet <Icon name="arrow-right" size={16} /></span>
                </div>
              </div>
            </a>
          </article>
        ))}
      </div>
    </section>

    <section class="categories-section">
      <div class="categories-shell">
        <div class="section-header">
          <div>
            <p class="section-kicker">Catégories</p>
            <h2 class="section-title"><Icon name="folders" class="icon-accent" /> Parcourir par thème</h2>
            <p class="section-subtitle">Trouvez rapidement ce que vous cherchez.</p>
          </div>
        </div>
        
        <div class="categories-grid">
          {categories.map(category => (
            <a href={base + `categories/${category.slug}`} class="category-card">
              <div class="category-icon">
                <Icon name={category.icon} size={32} class="icon-accent" />
              </div>
              <h3 class="category-name">{category.name}</h3>
              <span class="category-count">{category.count} article{category.count > 1 ? 's' : ''}</span>
            </a>
          ))}
        </div>
      </div>
    </section>

    <section id="liste-articles" class="page-section">
      <div class="section-header">
        <div>
          <p class="section-kicker">Tous les contenus</p>
          <h2 class="section-title"><Icon name="list" class="icon-accent" /> Liste complète</h2>
          <p class="section-subtitle">Cette section sera remplie au fur et à mesure de la publication de nos articles.</p>
        </div>
      </div>
    </section>
  </article>
</Layout>
